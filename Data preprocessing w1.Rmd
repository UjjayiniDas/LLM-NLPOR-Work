---
title: "Data Preprocessing for LLM"
author: "Ujjayini Das"
date: "`r Sys.Date()`"
output: html_document
---

# *********************
# Subset SIPP Data ----
#
# This script reads the SIPP 2014 person-level data from wave 1, subsets 
# the data for working age population and preprocesses the data for fine
# tuning LLM.
# *****************************************************************************


# *****************************************************************************
# Load Packages ----

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load `pacman` for pkg management
if (!require("pacman", character.only = TRUE)){
  install.packages("pacman", dep = TRUE)
  if (!require("pacman", character.only = TRUE))
    stop("Package not found")
}

# Packages to use
pkgs <- c("tidyverse",    # General data manipulation
          "dplyr",        # General data manipulation
          "dbplyr",       # Interface for databases
          "haven",        # Load Stata datasets
          "RSQLite",      # SQL
          "glue",         # For gluing
          "survey",       # Survey data analysis
          "srvyr",        # Survey data analysis
          "readxl",       # excel file reading
          "readr",        # reading text data
          "data.table",   # handling data table
          "purrr")        # data wrangling

# Install packages as needed
if(!sum(!p_isinstalled(pkgs)) == 0){
  p_install(package = pkgs[!p_isinstalled(pkgs)], character.only = TRUE)
}

# Load the packages
p_load(pkgs, character.only = TRUE)
rm(pkgs)
```

# *****************************************************************************
# Process Microdata ----

```{r}
# Load data from wave 1
SIPP_w1 <- read_csv("Data/SIPP14_Wave1_Cooked.csv")
var_rename <- read_excel("Data/rename columns.xlsx")
# Process for LLM
df_w1 <- SIPP_w1 %>%
  # Rename columns to more legible words
  setnames(., old = var_rename$old_name, new = var_rename$new_name) %>%
  # removing unnecessary columns
  select(-c(14,16,18,20,22)) %>%
  # sub-setting to working age population
  filter(age >= 15) %>%
  # collapsing education categories
  mutate(education =  ifelse(education %in% 31:38, "Less than high school",
                      ifelse(education == 39, "High school",
                      ifelse(education %in% 40:42, "Some college",
                      ifelse(education == 43, "Bachelor's degree",
                      ifelse(education %in% 44:46, "Postgraduate degree", education))))))
# setting `state` as numeric
df_w1$state <- as.numeric(df_w1$state)

# Re-coding values with text
# Step 1: Read the codebook
codebook <- read_csv("Data/SIPP14_Wave1_labels.csv")

# Step 2: Split the codebook by variable
code_mappings <- codebook %>%
  group_by(variable) %>%
  group_split()

# Step 3: Define replacement function (overwrite and remove code column)
replace_labels <- function(df, mapping_df) {
  var_name <- unique(mapping_df$variable)
  
  # Build a lookup table
  mapping_tbl <- mapping_df %>%
    select(code, label) %>%
    distinct()
  
  # Replace code with label in the main data
  df %>%
    left_join(mapping_tbl, by = setNames("code", var_name)) %>%
    mutate(!!sym(var_name) := .data$label) %>%
    select(-label)
}

# Step 4: Apply to all variables
df_w1_updated <- reduce(code_mappings, replace_labels, .init = df_w1)

# Converting age to character
df_w1_updated$age <- as.character(df_w1_updated$age)

# save as excel
#write_csv(df_w1_updated, "Data/Processed_for_LLM/SIPP14_Wave1_processed.csv")
```

## Qwen 7B finetune confusion matrix

```{r}
df_pred <- read_excel("./Predictions_QWEN7B/finetuned_snap_predictions_nonimputed.xlsx")
table(df_pred$Predicted_Label,df_pred$ImputedSIPP_Label)

df_imp_pred <- read_excel("./Predictions_QWEN7B/finetuned_qwen7b_predictions_imputed.xlsx")
table(df_imp_pred$Predicted_Label,df_imp_pred$ImputedSIPP_Label)

```

## Preprocessing for Longitudinal Imputation

## Wave 1 and Wave 2

```{r}
## Reading in wave 1 and 2 data as it is
wave1_full <- read_csv("Data/Processed_for_LLM/SIPP14_Wave1_processed.csv")
wave2_full <- read_csv("Data/Processed_for_LLM/SIPP14_Wave2_processed.csv")

## Creating unique ID (sample unit ID X person ID)
wave1_full <- wave1_full %>%
  mutate(unique_ID_1 = paste0(`sample unit ID`,"_",`person ID`)) %>%
  dplyr::select(-c(1:2,4:6,13:15,17:18,24:25,27:28))
wave2_full <- wave2_full %>%
  mutate(unique_ID_2 = paste0(`sample unit ID`,"_",`person ID`)) %>%
  dplyr::select(-c(1,3:6,13:14,16:17,20,24:25,27:28))

## Create merged data set
wave1and2_full <- merge(wave1_full,wave2_full, by.x = "unique_ID_1", by.y = "unique_ID_2")

## Dataset to feed into LLM
wave1and2_llm <- wave1and2_full %>%
  dplyr::select(-c(2:8,10:14,24,25)) %>%
  filter(imputed_snap.x == FALSE) %>%
  rename_with(~ gsub("\\.x$", "_wave1", .x)) %>%
  rename_with(~ gsub("\\.y$", "", .x))
# save as excel
#write_csv(wave1and2_llm, "Data/Processed_for_LLM/Wave1and2_processed.csv")
```


## Cleaning and processing wave 3 and 4 data

```{r}
# Process for LLM
SIPP_w3 <- read_csv("Data/SIPP14_Wave3_Cooked.csv")
df_w3 <- SIPP_w3 %>%
  # Rename columns to more legible words
  setnames(., old = var_rename$old_name, new = var_rename$new_name) %>%
  # removing unnecessary columns
  select(-c(14,16,18,20,22)) %>%
  # sub-setting to working age population
  filter(age >= 15) %>%
  # collapsing education categories
  mutate(education =  ifelse(education %in% 31:38, "Less than high school",
                      ifelse(education == 39, "High school",
                      ifelse(education %in% 40:42, "Some college",
                      ifelse(education == 43, "Bachelor's degree",
                      ifelse(education %in% 44:46, "Postgraduate degree", education))))))
# setting `state` as numeric
df_w3$state <- as.numeric(df_w3$state)

# Re-coding values with text
# Step 1: Read the codebook
codebook <- read_csv("Data/SIPP14_Wave1_labels.csv")

# Step 2: Split the codebook by variable
code_mappings <- codebook %>%
  group_by(variable) %>%
  group_split()

# Step 3: Define replacement function (overwrite and remove code column)
replace_labels <- function(df, mapping_df) {
  var_name <- unique(mapping_df$variable)
  
  # Build a lookup table
  mapping_tbl <- mapping_df %>%
    select(code, label) %>%
    distinct()
  
  # Replace code with label in the main data
  df %>%
    left_join(mapping_tbl, by = setNames("code", var_name)) %>%
    mutate(!!sym(var_name) := .data$label) %>%
    select(-label)
}

# Step 4: Apply to all variables
df_w3_updated <- reduce(code_mappings, replace_labels, .init = df_w3)

# Converting age to character
df_w3_updated$age <- as.character(df_w3_updated$age)

# save as excel
#write_csv(df_w3_updated, "Data/Processed_for_LLM/SIPP14_Wave3_processed.csv")


## Wave 4
SIPP_w4 <- read_csv("Data/SIPP14_Wave4_Cooked.csv")
df_w4 <- SIPP_w4 %>%
  # Rename columns to more legible words
  setnames(., old = var_rename$old_name, new = var_rename$new_name) %>%
  # removing unnecessary columns
  select(-c(14,16,18,20,22)) %>%
  # sub-setting to working age population
  filter(age >= 15) %>%
  # collapsing education categories
  mutate(education =  ifelse(education %in% 31:38, "Less than high school",
                      ifelse(education == 39, "High school",
                      ifelse(education %in% 40:42, "Some college",
                      ifelse(education == 43, "Bachelor's degree",
                      ifelse(education %in% 44:46, "Postgraduate degree", education))))))
# setting `state` as numeric
df_w4$state <- as.numeric(df_w4$state)

df_w4_updated <- reduce(code_mappings, replace_labels, .init = df_w4)

# Converting age to character
df_w4_updated$age <- as.character(df_w4_updated$age)

# save as excel
#write_csv(df_w4_updated, "Data/Processed_for_LLM/SIPP14_Wave4_processed.csv")
```

### Creating merged datasets
## merging wave 3 with wave 1 and 2 combined

```{r}
## Creating unique ID (sample unit ID X person ID)
wave3_full <- df_w3_updated %>%
  mutate(unique_ID_2 = paste0(`sample unit ID`,"_",`person ID`)) %>%
  dplyr::select(-c(1,3:6,13:14,16:20,24:25,27:28))

## merge with wave 1 and 2 combined
wave123_full <- merge(wave1and2_llm,wave3_full, by.x = "unique_ID_1", by.y = "unique_ID_2")

## final process for LLM
wave123_llm <- wave123_full %>%
  dplyr::select(-c(4:10,12:14)) %>%
  filter(imputed_snap.x == FALSE) %>%
  rename_with(~ gsub("\\.x$", "_wave2", .x)) %>%
  rename_with(~ gsub("\\.y$", "", .x))
# save as excel
write_csv(wave123_llm, "Data/Processed_for_LLM/Wave123_processed.csv")
```

## Wave 4 merging with wave 1,2,3 combined

```{r}
## Creating unique ID (sample unit ID X person ID)
wave4_full <- df_w4_updated %>%
  mutate(unique_ID_2 = paste0(`sample unit ID`,"_",`person ID`)) %>%
  dplyr::select(-c(1,3:6,13:14,16:20,24:25,27:28))

## merge with wave 1 and 2 combined
wave1234_full <- merge(wave123_llm,wave4_full, by.x = "unique_ID_1", by.y = "unique_ID_2")

## final process for LLM
wave1234_llm <- wave1234_full %>%
  dplyr::select(-c(6:12,14:16)) %>%
  filter(imputed_snap.x == FALSE) %>%
  rename_with(~ gsub("\\.x$", "_wave3", .x)) %>%
  rename_with(~ gsub("\\.y$", "", .x))
# save as excel
write_csv(wave1234_llm, "Data/Processed_for_LLM/Wave1234_processed.csv")
```